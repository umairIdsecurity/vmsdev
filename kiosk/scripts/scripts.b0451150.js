angular.module("kiosk.config",[]).constant("VMSConfig",{baseURL:"http://vmsdev.identitysecurity.com.au/index.php",authToken:"IzVPOD9PXjz26sSCPkKV",adminEmail:"tom@growthapps.net"}),angular.module("kioskApp",["kiosk.config","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angular-spinkit","kiosk.VisitorService","kiosk.CameraService","kiosk.ConfigService","kiosk.DataService","kiosk.VisitService"]).config(["$httpProvider","$routeProvider",function(a,b){b.when("/",{templateUrl:"views/intro.html",controller:"MainCtrl"}).when("/compliance",{templateUrl:"views/compliance.html",controller:"ComplianceCtrl"}).when("/visitor_email",{templateUrl:"views/visitor_email.html",controller:"VisitorEmailCtrl"}).when("/create_visitor_profile",{templateUrl:"views/create_visitor_profile.html",controller:"CreateVisitorCtrl"}).when("/host_search",{templateUrl:"views/host_search.html",controller:"HostSearchCtrl"}).when("/photo_capture",{templateUrl:"views/photo_capture.html",controller:"PhotoCaptureCtrl"}).when("/pickup_notice",{templateUrl:"views/pickup_notice.html",controller:"PickupNoticeCtrl"}).when("/check_out",{templateUrl:"views/check_out.html",controller:"CheckOutCtrl"}).when("/drop_off",{templateUrl:"views/drop_off.html",controller:"DropOffCtrl"}).otherwise({redirectTo:"/"}),a.defaults.headers.common={},a.defaults.headers.post={},a.defaults.headers.get={},a.defaults.headers.put={}}]),angular.module("kiosk.VisitorService",[]).factory("VisitorService",function(){var a={reset:function(){this.firstName=null,this.lastName=null,this.email=null,this.visitorID=null,this.companyName=null,this.password=null,this.termsAccepted=null,this.profilePhotoURL=null,this.host=null},setHost:function(a){this.host=a}};return a.reset(),a}),angular.module("kiosk.CameraService",[]).factory("CameraService",["$window",function(a){var b=function(){return!!c()},c=function(){return navigator.getUserMedia=a.navigator.getUserMedia||a.navigator.webkitGetUserMedia||a.navigator.mozGetUserMedia||a.navigator.msGetUserMedia,navigator.getUserMedia};return{hasUserMedia:b(),getUserMedia:c,currentStream:null,capturedPhotoURL:null}}]),angular.module("kioskApp").controller("MainCtrl",["$scope","$location","ConfigService",function(a,b,c){function d(){a.forwardButtonStyle=c.brandInfo.actionForwardButton,a.checkOutButtonStyle=c.brandInfo.neutralButton,a.imgSrc=c.brandInfo.companyLogoURL,a.tagLine=c.companyTagLine}a.$on("config:updated",d),a.changeView=function(){b.path("compliance")},d()}]),angular.module("kioskApp").controller("ComplianceCtrl",["$scope","$location","VisitorService","ConfigService",function(a,b,c,d){function e(){a.forwardButtonStyle=d.brandInfo.actionForwardButton,a.backButtonStyle=d.brandInfo.neutralButton}a.hasAgreed=!1,a.goBack=function(){b.path("/")},a.changeView=function(){b.path("/visitor_email"),c.termsAccepted=!0},a.questions=d.complianceTerms,null===a.questions||0===a.questions.length,e()}]),angular.module("kioskApp").controller("VisitorEmailCtrl",["$scope","$location","VisitorService","DataService","ConfigService",function(a,b,c,d,e){function f(){a.forwardButtonStyle=e.brandInfo.actionForwardButton,a.backButtonStyle=e.brandInfo.neutralButton}a.hasError=!1,a.email=null,a.$watch("visitor_email",function(b){a.email={text:b},c.email=a.email.text}),a.target=null,a.loadVisitorInfo=function(){var b=function(b,d){a.hasError=!1;var e=["visitorID","firstName","lastName","email"];angular.forEach(e,function(a){c[a]=b[a]}),a.target="host_search",a.navigateToNext()},e=function(b,c){404==c?(a.target="create_visitor_profile",a.navigateToNext()):a.hasError=!0};d.getVisitor(c.email,b,e)},a.navigateToNext=function(){b.path(a.target)},a.goBack=function(){b.path("compliance")},f()}]),angular.module("kioskApp").controller("CreateVisitorCtrl",["$scope","VisitorService","$location","DataService","ConfigService",function(a,b,c,d,e){function f(){a.forwardButtonStyle=e.brandInfo.actionForwardButton,a.backButtonStyle=e.brandInfo.neutralButton}a.hasError=!1,a.goBack=function(){c.path("visitor_email")},a.currentVisitor=b,a.createLogin=function(){b.firstName=a.currentVisitor.firstName,b.lastName=a.currentVisitor.lastName,b.companyName=a.currentVisitor.companyName,b.email=a.currentVisitor.email,d.createVisitor(b,function(d,e){b.visitorID=d.visitorID,b.companyID=d.companyID,console.log("Got visitor ID: "+b.visitorID),c.path("host_search"),a.hasError=!1},function(b,c){console.log("Error creating new visitor: "+b),a.hasError=!0})},f()}]),angular.module("kioskApp").controller("HostSearchCtrl",["$scope","$location","VisitorService","$http","DataService","VisitService","ConfigService",function(a,b,c,d,e,f,g){function h(){a.forwardButtonStyle=g.brandInfo.actionForwardButton,a.backButtonStyle=g.brandInfo.neutralButton}a.hasError=!1,a.visitor=c,a.host=null,a.hostOptions=[],a.query="",a.choose=function(b){a.host=b,a.query=null},a.notifyHost=function(){c.setHost(a.host),e.createVisit({visitorID:c.visitorID,hostID:c.host.hostID,visitorType:2,startTime:(new Date).toJSON(),expectedEndTime:(new Date).toJSON(),visitReason:1,workstation:8},function(c,d){var e=c[0];f.visitID=e.visitID,a.hasError=!1,console.log("Got visitID: "+e.visitID),b.path("photo_capture")},function(b,c){console.log("Create visit failed: "+b),a.hasError=!0})},a.performNewSearch=function(){a.hostOptions=[],a.query.length>3&&(a.host=null,e.searchHost(a.query,function(b,c){a.hostOptions=b;var d=null;d=b.length>5?b.slice(0,5):b,a.hostOptions=d},function(b,c){a.hostOptions=[]}))},a.goBack=function(){b.path("visitor_email")},h()}]),angular.module("kioskApp").controller("PhotoCaptureCtrl",["$scope","$location","CameraService","VisitorService","DataService","ConfigService",function(a,b,c,d,e,f){function g(){a.forwardButtonStyle=f.brandInfo.actionForwardButton,a.backButtonStyle=f.brandInfo.neutralButton}a.hasError=!1,a.showControls=!0,a.showSpinner=!1;var h=function(){b.path("pickup_notice")};a.useCapturedPhoto=function(){console.log("uploading..."),a.showSpinner=!0,a.showControls=!1,d.profilePhotoURL=c.capturedPhotoURL,e.uploadPhoto(d.profilePhotoURL,function(a,b){h()},function(b,c){a.hasError=!0})},a.goBack=function(){b.path("host_search")},g()}]),angular.module("kioskApp").directive("camera",["CameraService",function(a){return{templateUrl:"views/camera_capture.html",restrict:"EA",replace:!0,transclude:!0,scope:{callBack:"&captureCallback"},controller:["$scope","$q","$timeout",function(b,c,d){b.retake=function(){b.isShowingPreview=!1},b.usePhoto=function(){a.currentStream.stop(),b.callBack()},b.isShowingPreview=!1,this.takeSnapshot=function(){var e=document.querySelector("canvas"),f=e.getContext("2d"),g=document.querySelector("video"),h=c.defer();return e.width=g.videoWidth,e.height=g.videoHeight,d(function(){f.fillRect(0,0,b.w,b.h),console.log(e.width,e.height),f.drawImage(g,0,0,e.width,e.height);var c=e.toDataURL("image/png");console.log("Img Data URL: "+c),a.capturedPhotoURL=c,h.resolve(c),b.isShowingPreview=!0},0),h.promise}}],link:function(b,c,d){var e=d.width||700,f=d.heigh||300;if(a.hasUserMedia){var g=(a.getUserMedia(),document.querySelector("video")),h=function(b){if(a.currentStream=b,navigator.mozGetUserMedia)g.mozSrcObject=b;else{window.URL||window.webkitURL;g.src=window.URL.createObjectURL(b)}g.play()},i=function(a){console.error(a)};navigator.getUserMedia({video:{mandatory:{maxHeight:f,maxWidth:e}},audio:!1},h,i),b.w=e,b.h=f}}}}]).directive("cameraControlSnapshot",function(){return{restrict:"EA",require:"^camera",scope:!0,template:'<a id="snapshotButton" class="capture-btn" ng-click="takeSnapshot()"><img  style="width:100px;" src="http://imgur.com/nQtAKqy.jpg"></img><br/>CAPTURE IMAGE</a>',link:function(a,b,c,d){var e=$("#snapshotButton").first(),f=$(".camera");f.append(e),a.takeSnapshot=function(){d.takeSnapshot().then(function(a){})}}}}),angular.module("kioskApp").controller("PickupNoticeCtrl",["$scope","$location","ConfigService","VisitorService",function(a,b,c,d){a.pickupLocation=c.pickupLocation,a.startOver=function(){b.path("/"),d.reset()}}]),angular.module("kiosk.ConfigService",[]).factory("ConfigService",["$rootScope","DataService",function(a,b){function c(a){e.brandInfo.companyLogoURL=a.companyLogoURL;var b=["actionForwardButton","completeButton","neutralButton","navigationMenu","sideMenueAndHeaderText"];angular.forEach(b,function(b){angular.forEach(a[b],function(a,c){if("hover"!=c.substring(0,5)){var d=c.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();e.brandInfo[b][d]=a}})})}function d(){b.getAdmin(function(b,d){e.companyName=b.companyName,e.pickupLocation=b.VICPickupLocation,e.complianceTerms=b.complianceTerms,console.log(e.complianceTerms),e.companyTagLine=b.companyTagLine.toUpperCase(),c(b.brandInfo),a.$broadcast("config:updated",e)},function(a,b){e.error=a})}var e={companyTagLine:"",pickupLocation:"Reception",brandInfo:{companyLogoURL:"../../images/IDSecLogo.png",actionForwardButton:{},completeButton:{},neutralButton:{},navigationMenu:{},sideMenueAndHeaderText:{}}};return d(),e}]),angular.module("kioskApp").controller("CheckOutCtrl",["$scope","$location","ConfigService","DataService",function(a,b,c,d){function e(){a.forwardButtonStyle=c.brandInfo.actionForwardButton,a.backButtonStyle=c.brandInfo.neutralButton}a.hasError=!1,a.searchVisits=function(b){a.visit=null,console.log('searching visits matching: "'+b+'"'),d.searchVisits(b,function(b,c){console.log("Success: "+c),a.visits=b,a.hasError=!1},function(b,c){console.log("Error: "+c+" Scope: "+a),404!=c&&(a.hasError=!0)})},a.choose=function(c){a.visit=c,console.log(c),d.checkOutVisit(c,function(a,c){b.path("drop_off")},function(b,c){a.hasError=!0})},a.goBack=function(){b.path("/")},a.visits=null,a.visit=null,e()}]),angular.module("kioskApp").controller("DropOffCtrl",["$scope","ConfigService","$location",function(a,b,c){a.dropOffLocation=b.pickupLocation,a.startOver=function(){c.path("/")}}]),angular.module("kiosk.DataService",[]).factory("DataService",["$http","VisitService","VMSConfig",function(a,b,c){console.log("Data service got config: "+c);var d=c.authToken;return a.defaults.headers.common.HTTP_X_VMS_TOKEN=d,{baseURL:c.baseURL,adminEmail:c.adminEmail,getAdmin:function(b,c){var d=this.baseURL+"/admin/"+this.adminEmail;console.log("GET: "+d),a.get(d).success(b).error(c)},getVisitor:function(b,c,d){var e=this.baseURL+"/visitor/"+b;console.log("GET: "+e),a.get(e).success(c).error(d)},searchHost:function(b,c,d){var e=this.baseURL+"/host/search?query="+escape(b);console.log("GET: "+e),a.get(e).success(c).error(d)},createVisit:function(b,c,d){var e=this.baseURL+"/visit";console.log("POST: "+e),a.post(e,b).success(c).error(d)},uploadPhoto:function(c,d,e){var f=this.baseURL+"/visit/"+b.visitID+"/file/";console.log("POST: "+f);for(var g=atob(c.split(",")[1]),h=[],i=0;i<g.length;i++)h.push(g.charCodeAt(i));var j=new Blob([new Uint8Array(h)],{type:"image/png"}),k=new FormData;k.append("file",j,"filename.png"),a.post(f,k).success(d).error(e)},createVisitor:function(b,c,d){var e=this.baseURL+"/visitor",f={firstName:b.firstName,lastName:b.lastName,email:b.email,company:"1",password:"123456",visitorType:"2"};console.log("POST: "+e),a.post(e,f).success(c).error(d)},searchVisits:function(b,c,d){var e=this.baseURL+"/visit?VICNumber="+b;console.log("GET: "+e),a.get(e).success(c).error(d)},checkOutVisit:function(b,c,d){var e=this.baseURL+"/visit/",f={visitID:b.visitID,visitorID:b.visitorID,hostID:b.hostID,visitorType:b.visitorType,startTime:b.startTime,expectedEndTime:b.expectedEndTime,checkOutTime:(new Date).toJSON(),visitReason:1,workstation:8};console.log("PUT: "+e),a.put(e,f).success(c).error(d)}}}]),angular.module("kiosk.VisitService",[]).factory("VisitService",function(){return{visitID:null}});